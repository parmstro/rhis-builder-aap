---

# Stat, delete keys, cleanup authorized_keys
- name: "The .ssh directory should exist"
  ansible.builtin.stat:
    path: "/root/.ssh/"
  register: stat_result

- name: "Clean it up if it does"
  when: stat_result.stat.exists
  block:

    - name: "Remove the private key that we copied"
      ansible.builtin.file:
        path: "/root/.ssh/rhis_builder_id"
        state: absent

    - name: "Remove the public key that we copied"
      ansible.builtin.file:
        path: "/root/.ssh/rhis_builder_id.pub"
        state: absent

    - name: "Create an authorized key file on the aap host"
      ansible.builtin.blockinfile:
        block: "{{ lookup('file', builder_pub_file_vault) }}"
        path: "/root/.ssh/authorized_keys"
        marker: "rhis-builder-aap"
        state: absent
        owner: "root"
        group: "root"
        mode: "0600"
